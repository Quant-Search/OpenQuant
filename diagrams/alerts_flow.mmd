flowchart TD
  S[Start Run] --> B1[Snapshot best_configs BEFORE]
  B1 --> E[Evaluate rows]
  E --> G{Guardrails}
  G -- violations --> V[Record violation]
  G -- pass --> C[Apply concentration limits]
  V --> C
  C --> U[Upsert rows to DuckDB]
  U --> B2[Snapshot best_configs AFTER]
  B2 --> D[Diff snapshots]
  D --> RS[Format run summary]
  RS --> A{Webhook configured?}
  A -- yes --> W[POST JSON to webhook]
  A -- no --> L[Log locally]
  RS --> F[Write run_summary_*.md]
  C --> P[Propose portfolio allocation]
  P --> J[Write allocation_*.json]

